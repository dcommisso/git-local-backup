#!/usr/bin/sh

GIT_LOCAL_BACKUP_DIR=$(git config get gitlocalbackup.directory)

HEADER="################"
BACKUP_DISABLED_MESSAGE=$(printf 'local backup disabled. Run:\n$ git config set gitlocalbackup.directory <BACKUP-DIRECTORY>\nto enable it')

if [ -z "$GIT_LOCAL_BACKUP_DIR" ]; then
    printf '\n%s\n%s\n%s\n\n' "$HEADER" "$BACKUP_DISABLED_MESSAGE" "$HEADER"
    exit 0
fi

REPO_NAME=$(basename "$(git rev-parse --show-toplevel)")
BACKUP_FILE=$REPO_NAME-$(date '+%Y%m%d%H%M%S')
BACKUP_FULL_PATH=$GIT_LOCAL_BACKUP_DIR/$BACKUP_FILE
BACKUP_SUCCESSFUL_MESSAGE=$(printf 'backup created: %s' "$BACKUP_FULL_PATH")

# exit if backup directory doesn't exist
if [ ! -d "$GIT_LOCAL_BACKUP_DIR" ]; then
    echo $HEADER
    printf "git-local-backup error: %s directory doesn't exist\n" "$GIT_LOCAL_BACKUP_DIR"
    echo $HEADER
    echo
    exit 1
fi

if ! git bundle create "$BACKUP_FULL_PATH" --all; then
    exit 1
fi

printf '\n%s\n%s\n%s\n\n' "$HEADER" "$BACKUP_SUCCESSFUL_MESSAGE" "$HEADER"
